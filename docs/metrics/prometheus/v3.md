# How to monitor MinIO server with Prometheus? [![Slack](https://slack.min.io/slack?type=svg)](https://slack.min.io)

[Prometheus](https://prometheus.io) is a cloud-native monitoring platform. Prometheus offers a multi-dimensional data model with time series data identified by metric name and key/value pairs. The data collection happens via a pull model over HTTP/HTTPS. MinIO exports various prometheus compatible metrics at granular levels. Refer [MinIO v3 metrics](https://min.io/docs/metrics/prometheus/v3.md). As metrics are exported through various granular endpoints, users looking to monitor their MinIO instances need to use [Service Discovery](https://prometheus.io/docs/guides/file-sd/) mechanism to scrape all the metrics from different endpoint under same scrape job.

This document explains how to setup Prometheus and configure it to scrape data from MinIO servers.

## Prerequisites

To get started with MinIO, refer [MinIO QuickStart Document](https://min.io/docs/minio/linux/index.html#quickstart-for-linux).
Follow below steps to get started with MinIO monitoring using Prometheus.

### 1. Download Prometheus

[Download the latest release](https://prometheus.io/download) of Prometheus for your platform, then extract it

```sh
tar xvfz prometheus-*.tar.gz
cd prometheus-*
```

Prometheus server is a single binary called `prometheus` (or `prometheus.exe` on Microsoft Windows). Run the binary and pass `--help` flag to see available options

```sh
./prometheus --help
usage: prometheus [<flags>]

The Prometheus monitoring server

. . .
```

Refer [Prometheus documentation](https://prometheus.io/docs/introduction/first_steps/) for more details.

### 2. Configure authentication type for Prometheus metrics

MinIO supports two authentication modes for Prometheus either `jwt` or `public`, by default MinIO runs in `jwt` mode. To allow public access without authentication for prometheus metrics set environment as follows.

```
export MINIO_PROMETHEUS_AUTH_TYPE="public"
minio server ~/test
```

### 3. Configuring Prometheus

#### 3.1 Authenticated Prometheus config

> If MinIO is configured to expose metrics without authentication, you don't need to use `mc` to generate prometheus config. You can skip reading further and move to 3.2 section.

The Prometheus endpoint in MinIO requires authentication by default. Prometheus supports a bearer token approach to authenticate prometheus scrape requests, override the default Prometheus config with the one generated using mc. To generate a Prometheus config for an alias, use [mc](https://min.io/docs/minio/linux/reference/minio-mc.html#quickstart) as follows `mc admin prometheus generate <alias>`.

The command will generate the `scrape_configs` section of the prometheus.yml as follows:

##### Cluster

```yaml
scrape_configs:
- job_name: minio-job
  bearer_token: <secret>
  scheme: http
  file_sd_configs:
  - files:
    - 'targets.json'
```

Here `file_sd_configs` defines the list of `Service Discovery` files. The service discovery files basically list all the scrape endpoints (metrics_path) with their targets. All the targets listed under targets.json would be scraped by prometheus under same scrape job `minio-job`.

#### 3.2 Public Prometheus config

If Prometheus endpoint authentication type is set to `public`. Following prometheus config is sufficient to start scraping metrics data from MinIO.
This can be collected from any server once per collection.

##### Cluster

```yaml
scrape_configs:
- job_name: minio-job
  scheme: http
  file_sd_configs:
  - files:
    - 'targets.json'
```

### 4. Update `scrape_configs` section in prometheus.yml

To authorize every scrape request, copy and paste the generated `scrape_configs` section in the prometheus.yml and restart the Prometheus service.

### 5. Start Prometheus

Start (or) Restart Prometheus service by running

```sh
./prometheus --config.file=prometheus.yml
```

Here `prometheus.yml` is the name of configuration file. You can now see MinIO metrics in Prometheus dashboard. By default Prometheus dashboard is accessible at `http://localhost:9090`.

Prometheus sets the `Host` header to `domain:port` as part of HTTP operations against the MinIO metrics endpoint. For MinIO deployments behind a load balancer, reverse proxy, or other control plane (HAProxy, nginx, pfsense, opnsense, etc.), ensure the network service supports routing these requests to the deployment.

### 6. Configure Grafana

After Prometheus is configured, you can use Grafana to visualize MinIO metrics. Refer the [document here to setup Grafana with MinIO prometheus metrics](https://github.com/minio/minio/blob/master/docs/metrics/prometheus/grafana/v3.md).

## How to `Service Discovery` file

A sample service discovery file for MinIO metrics could be as below

```json
[
        {
                "targets": ["<MINIO URL>"],
                "labels": {"__metrics_path__": "/minio/metrics/v3/cluster/health"}
        },
        {
                "targets": ["<MINIO URL>"],
                "labels": {"__metrics_path__": "/minio/metrics/v3/cluster/notification"}
        },
        {
                "targets": ["<MINIO URL>"],
                "labels": {"__metrics_path__": "/minio/metrics/v3/system/drive"}
        },
        {
                "targets": ["<MINIO URL>"],
                "labels": {"__metrics_path__": "/minio/metrics/v3/system/memory"}
        },
        {
                "targets": ["<MINIO URL>"],
                "labels": {"__metrics_path__": "/minio/metrics/v3/system/cpu"}
        },
        {
                "targets": ["<MINIO URL>"],
                "labels": {"__metrics_path__": "/minio/metrics/v3/api/requests"}
        },
        {
                "targets": ["<MINIO URL>"],
                "labels": {"__metrics_path__": "/minio/metrics/v3/cluster/erasure-set"}
        },
        {
                "targets": ["<MINIO URL>"],
                "labels": {"__metrics_path__": "/minio/metrics/v3/cluster/usage/objects"}
        },
        {
                "targets": ["<MINIO URL>"],
                "labels": {"__metrics_path__": "/minio/metrics/v3/api/bucket/<BUCKET>"}
        },
        {
                "targets": ["<MINIO URL>"],
                "labels": {"__metrics_path__": "/minio/metrics/v3/cluster/usage/buckets/<BUCKET>"}
        }
]
```

As metrics like `/minio/metrics/v3/cluster/usage/buckets/<BUCKET>` and `/minio/metrics/v3/api/bucket/<BUCKET>` are dependent on bucket names, in production deployment, user may need to maintain a crobjob which fogures out list of buckets on regular basis and keeps updating the targets.json. Reload of the service discovery file is automatically taken care by prometheus.

A sample bash script which can be set for cronjob for creation of Service Discovery file could be as below

```sh
#!/bin/bash

if [ ! -f ./mc ]; then
        wget --quiet -O mc https://dl.minio.io/client/mc/release/linux-amd64/mc &&
                chmod +x mc
fi

# REPLACE THE VALUES FOR ACCESS KEY, SECRET KEY AND MINIO URL
export MC_HOST_myminio="http://<ACCESS KEY>:<SECRET KEY>@<MINIO URL>/"

cat >/etc/minio/prometheus/targets.json <<EOF
[
        {
                "targets": ["<MINIO URL>"],
                "labels": {"__metrics_path__": "/minio/metrics/v3/cluster/health"}
        },
        {
                "targets": ["<MINIO URL>"],
                "labels": {"__metrics_path__": "/minio/metrics/v3/cluster/notification"}
        },
        {
                "targets": ["<MINIO URL>"],
                "labels": {"__metrics_path__": "/minio/metrics/v3/system/drive"}
        },
        {
                "targets": ["<MINIO URL>"],
                "labels": {"__metrics_path__": "/minio/metrics/v3/system/memory"}
        },
        {
                "targets": ["<MINIO URL>"],
                "labels": {"__metrics_path__": "/minio/metrics/v3/system/cpu"}
        },
        {
                "targets": ["<MINIO URL>"],
                "labels": {"__metrics_path__": "/minio/metrics/v3/api/requests"}
        },
        {
                "targets": ["<MINIO URL>"],
                "labels": {"__metrics_path__": "/minio/metrics/v3/cluster/usage/objects"}
        },
        {
                "targets": ["<MINIO URL>"],
                "labels": {"__metrics_path__": "/minio/metrics/v3/cluster/erasure-set"}
        }
]
EOF

for bkt in $(mc ls myminio --json | jq '.key' | sed 's/"//g' | cut -d '/' -f1); do
    local MINIO_URL="<MINIO URL>"
    local METRIC_1="/minio/metrics/v3/api/bucket/$bkt"
    local METRIC_2="/minio/metrics/v3/cluster/usage/buckets/$bkt"
    jq --arg URL "${MINIO_URL}" METRIC "${METRIC_1}" '. += [{"targets": [$URL], "labels": {"__metrics_path__": $BKT}}]' /etc/minio/prometheus/targets.json > tmp.json && mv tmp.json /etc/minio/prometheus/targets.json
    jq --arg URL "${MINIO_URL}" METRIC "${METRIC_2}" '. += [{"targets": [$URL], "labels": {"__metrics_path__": $BKT}}]' /etc/minio/prometheus/targets.json > tmp.json && mv tmp.json /etc/minio/prometheus/targets.json
done
```

### List of metrics reported Cluster and Bucket level

[The list of metrics reported can be here](https://github.com/minio/minio/blob/master/docs/metrics/v3.md)

### Configure Alerts for Prometheus

[The Prometheus AlertManager and alerts can be configured following this](https://github.com/minio/minio/blob/master/docs/metrics/prometheus/alerts.md)
